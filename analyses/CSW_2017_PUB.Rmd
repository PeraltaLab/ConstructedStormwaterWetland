---
title: Examining environmental drivers on greenhouse gas production and denitrification
  potential in a constructed stormwater wetland (aka 2017 CSW)
author: "Regina B. Bledsoe, Ariane L. Peralta"
date: "Last updated on `r format(Sys.time(), '%d %B, %Y')`"
#output:
  #pdf_document: null
  #editor_options: null
  #fig_caption: yes
  #html_document: default
  #word_document: default
  #chunk_output_type: 
---
Project Description: Analysis of seasonal denitrification potential and greenhouse gas production in a constructed stormwater wetland (Greenville, NC, USA).

```{r setup, include=FALSE}
#clears R environment
rm(list = ls())
#use to set global options for chunks e.g., echo and warning options will be applied to all chuncks
knitr::opts_chunk$set(echo = FALSE, warning=FALSE)
#use to set working directory 
knitr::opts_knit$set(root.dir="../GitHub/ConstructedStormwaterWetland/analyses")
#list.files()
```

```{r setup load packages}
getwd()
#Set source R tools
source("../bin/DiversityFunctions.R")
source("../bin/MothurTools.R")
#load requires packages
require("ggplot2")
require("psych")
require("tidyverse")
require("agricolae")
require("vegan")
require("reshape2") #need for pcoa
require("labdsv")
require("phyloseq")
require("lme4")
require("car")
require("MASS")
require("lindia")
require("blme")
require("dbstats")
require("emmeans")
require("multcomp")
require("AICcmodavg")
require("MuMIn")

#BiocManager::install("phyloseq")

#Set Std Err and Conf Int
se <- function(x, ...) {
  sd(x, na.rm = TRUE)/sqrt(length(na.omit(x)))
}
ci <- function(x, ...) {
  1.96 * sd(x, na.rm = TRUE)
}
cbrt<- function(x) { sign(x) * abs(x)^1/3 
  }
set.seed(42)

```

```{r read in ghg and environmental data}
#getwd()

#ghg flux data. measured values
ghg <- read.csv("../data/CSW_GHG_Flux.csv", header=T)
#design data. categorical values ans soil measurements
design <-read.csv("../data/CSW_field_design_soil.csv", header=T)
#water nutrient data 
water <- read.csv("../data/CSW_Water_nutes.csv")

#ghg flux is calcualted from 4 timepoints. first we need to remove lines without flux calcuations. 
ghg <- ghg[,-c(3:4,6:14)]
ghg <- filter(ghg, !is.na(ghg$ch4cgm2day))
#now can combine design and ghg datasets
ghg <- cbind(ghg, design)

#Add calculated fields
ghg <- mutate(ghg, 
      co2ch4=ghg$ch4cmgm2hr/ghg$co2cmgm2hr, #ch4:co2 ratio   
      ch4co2eq=ghg$ch4cmgm2hr*34, #methane carbon dioxide equivalents
      #radiative force of methane now estimated at 34x greater than CO2, was 25
      n2oco2eq=ghg$n2onmgm2hr*298 #nitrous oxide carbon dixode equivalents
      )
```

```{r plot formatting}
colman <- c("blue","chartreuse4")
hydro_label <- c("flooded", "shallow land")
season_label <- c("sp" = "spring", "sm" = "summer", "f" = "fall", "w" = "winter")
colseason <- c("brown","orange","green4","navyblue") #changed color order follows f, sm, sp, w
```

```{r GHG summary}
#I want to know if hydrology, season, distance.m (from inlet to outlet), or num.days.last.rain has the greatest influence on CH4, CO2, and N2O fluxes from the wetland

#Coverted distance.m to categorical factor, it is the same each sampling
#inlet:1w, 6t, 7t  #middle:2w, 3w, 8t, 9t, 10t    outlet: 4w, 5w, 11t, 12t, 13t   #upland 14t, 15t

#Quick Data Summary
hydro.ghg.summary <- ghg %>%
  group_by(hydrology)%>%
  dplyr::summarise(mean_ch4cmgm2hr=mean(ch4cmgm2hr), sd_ch4cmgm2hr=sd(ch4cmgm2hr),mean_co2cmgm2hr=mean(co2cmgm2hr), sd_co2cmgm2hr=sd(co2cmgm2hr),mean_n2onmgm2hr=mean(n2onmgm2hr), sd_n2onmgm2hr=sd(n2onmgm2hr))

hydro.ghg.summary

write.csv(hydro.ghg.summary, file="../figures/hydro.ghg.summary.csv")

rain.ghg.summary <- ghg %>%
  group_by(hydrology, num.days.last.rain)%>%
  dplyr::summarise(mean_ch4cmgm2hr=mean(ch4cmgm2hr), sd_ch4cmgm2hr=sd(ch4cmgm2hr),mean_co2cmgm2hr=mean(co2cmgm2hr), sd_co2cmgm2hr=sd(co2cmgm2hr),mean_n2onmgm2hr=mean(n2onmgm2hr), sd_n2onmgm2hr=sd(n2onmgm2hr))

rain.ghg.summary

dist.ghg.summary <- ghg %>%
  group_by(hydrology, distance.bin)%>%
  dplyr::summarise(mean_ch4cmgm2hr=mean(ch4cmgm2hr), sd_ch4cmgm2hr=sd(ch4cmgm2hr),mean_co2cmgm2hr=mean(co2cmgm2hr), sd_co2cmgm2hr=sd(co2cmgm2hr),mean_n2onmgm2hr=mean(n2onmgm2hr), sd_n2onmgm2hr=sd(n2onmgm2hr))

dist.ghg.summary

season.ghg.summary <- ghg %>%
  group_by(hydrology, season)%>%
  dplyr::summarise(mean_ch4cmgm2hr=mean(ch4cmgm2hr), sd_ch4cmgm2hr=sd(ch4cmgm2hr),mean_co2cmgm2hr=mean(co2cmgm2hr), sd_co2cmgm2hr=sd(co2cmgm2hr),mean_n2onmgm2hr=mean(n2onmgm2hr), sd_n2onmgm2hr=sd(n2onmgm2hr))

season.ghg.summary

write.csv(season.ghg.summary, file="../figures/season.ghg.summary.csv")

#CH4
min(ghg$ch4cmgm2hr)
max(ghg$ch4cmgm2hr)
#CO2
min(ghg$co2cmgm2hr)
max(ghg$co2cmgm2hr)
#N2O
min(ghg$n2onmgm2hr)
max(ghg$n2onmgm2hr)

```
```{r CH4 Quick visualization} 
#Mike suggested violin plots so I gave it a go and they were very squished
ggplot(aes(x=sampleid, y=ch4cmgm2hr, color=hydrology), data=ghg)+
  geom_violin(trim=FALSE) +
  facet_grid(~season)
#maybe boxplots are not so bad in this case?
ggplot(aes(x=season, y=ch4cmgm2hr, fill=hydrology), data=ghg)+
  geom_boxplot()

ggplot(aes(x=sampleid, y=ch4cmgm2hr, color=hydrology), data=ghg)+
  geom_boxplot()
```

```{r CH4 Do we have normaility?}
#First check the distibution of residuals --- not so great
ch4.lm <- lmer(ch4cmgm2hr~(1|sampleid), data=ghg, REML=TRUE)
summary(ch4.lm, ddf="Kenward-Roger")
confint(ch4.lm)
p=profile(ch4.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(ch4.lm), main="QQ Plot")
shapiro.test(resid(ch4.lm))

#Try cuberoot - works with negative values
ghg$cbrt.ch4 <- cbrt(ghg$ch4cmgm2hr)

ch4.lm <- lmer(cbrt.ch4~(1|sampleid), data=ghg, REML=TRUE)
summary(ch4.lm, ddf="Kenward-Roger")
confint(ch4.lm)
p=profile(ch4.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(ch4.lm), main="QQ Plot")
shapiro.test(resid(ch4.lm))

#Since dataset still not normal... going to try log by first adding a constant to deal with < 0 values
m <- min(ghg$ch4cmgm2hr)
ghg$log.ch4 <- sign(ghg$ch4cmgm2hr) * log10(1 - m + ghg$ch4cmgm2hr)


ch4.lm <- lmer(log.ch4~(1|sampleid), data=ghg, REML=TRUE)
summary(ch4.lm, ddf="Kenward-Roger")
confint(ch4.lm)
p=profile(ch4.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(ch4.lm), main="QQ Plot")
shapiro.test(resid(ch4.lm))

ghg$log.cb.ch4 <- log(abs(ghg$ch4cmgm2hr)^(1/3))

ch4.lm <- lmer(log.cb.ch4~(1|sampleid), data=ghg, REML=TRUE)
summary(ch4.lm, ddf="Kenward-Roger")
confint(ch4.lm)
p=profile(ch4.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(ch4.lm), main="QQ Plot")
shapiro.test(resid(ch4.lm))

#boxcox when non-normality is presistant
ghg$bc.ch4 <- boxCoxVariable(abs(ghg$ch4cmgm2hr))
ch4.lm <- lmer(bc.ch4~(1|sampleid), data=ghg, REML=TRUE)
summary(ch4.lm, ddf="Kenward-Roger")
confint(ch4.lm)
p=profile(ch4.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(ch4.lm), main="QQ Plot")
shapiro.test(resid(ch4.lm))
#This tells you what lambda value to scale data too
#Keep getting error. Think issue with negatvie values

```
```{r Hypothesis testing log}
#Which factor/s (Hydrology, season, distance.bin) help explain GHG production?

#ANOVA is is not best here because it treats each observation as an independent observation but can not account for the randomness from sampling the same location. 
#Each sampling plot is measured for GHG monthly over 1 year (n=12). 

#First I want to compare the randomness to parameters that I think might be influencing the response variable. In this case I want to know if hydrology, distance from the inlet, or season influence method production 

ch4.lm1 <- lmer(log.cb.ch4 ~ (1|sampleid) , data=ghg)

ch4.lm2 <- lmer(log.cb.ch4~hydrology + (1|sampleid), data=ghg)

ch4.lm3 <- lmer(log.cb.ch4~distance.bin + (1|sampleid), data=ghg)

ch4.lm4 <- lmer(log.cb.ch4~hydrology * distance.bin + (1|sampleid), data=ghg)

ch4.lm4a <- lmer(log.cb.ch4~hydrology + distance.bin + (1|sampleid), data=ghg)

ch4.lm5 <- lmer(log.cb.ch4~season+ (1|sampleid), data=ghg)

ch4.lm6 <- lmer(log.cb.ch4~hydrology * season + (1|sampleid), data=ghg)

ch4.lm7 <- lmer(log.cb.ch4~distance.bin * season+ (1|sampleid), data=ghg)

ch4.lm7a <- lmer(log.cb.ch4~distance.bin + season+ (1|sampleid), data=ghg)

ch4.lm8 <- lmer(log.cb.ch4~hydrology * distance.bin * season + (1|sampleid), data=ghg)

ch4.lm8a <- lmer(log.cb.ch4~hydrology + distance.bin + season + (1|sampleid), data=ghg)

ch4.lm9 <- lmer(log.cb.ch4~hydrology +  season + (1|sampleid), data=ghg)

#This is a liklihood ratio test to get Chi squared value and p-value
a <- anova(ch4.lm1, ch4.lm2, ch4.lm3,ch4.lm4,ch4.lm5, ch4.lm6, ch4.lm7, ch4.lm8, ch4.lm9, ch4.lm4a, ch4.lm7a, ch4.lm8a)
a
anova(ch4.lm6)

#AIC weights
c.mod <- list(ch4.lm1, ch4.lm2, ch4.lm3,ch4.lm4,ch4.lm5, ch4.lm6, ch4.lm8)
Modnames <- c("null", "hydrology", "distance", "H*D", "season", "H*S", "H*D*S")
aictab(cand.set = c.mod, modnames = Modnames, second.ord = TRUE)


#Variance explained by fixed effects and the entire model
r.squaredGLMM(ch4.lm1) #null
r.squaredGLMM(ch4.lm2) #hydrology
r.squaredGLMM(ch4.lm5) #season
r.squaredGLMM(ch4.lm3) #distance bin
r.squaredGLMM(ch4.lm6) #season * hydrology
r.squaredGLMM(ch4.lm4) #season * distance
r.squaredGLMM(ch4.lm8) #season * hydrology * distance.bin

#My conclusion is that hyrdology is the main factor and season is secondary factor in influencing methane rates within the wetland

summary(ch4.lm6, ddf="Kenward-Roger")
confint.merMod(ch4.lm6, oldNames = FALSE)
p=profile(ch4.lm6)
xyplot(p)
densityplot(p)
qqPlot(resid(ch4.lm6), main="QQ Plot")
shapiro.test(resid(ch4.lm6))

#Post hoc Tests
#Estimated marginal means - similar to lsmeans, uses t distribution
#https://cran.rstudio.com/web/packages/emmeans/vignettes/interactions.html

  emm <- emmeans(ch4.lm6, ~hydrology * season, adjust = "tukey")
  pairs(emm)
  multcomp::cld(emm, Letters=letters)
  #p <-contrast(emm, "consec", simple="each", combine =TRUE, adjust="mvt")
  #p
  
  

```

```{r Hypothesis testing not log}

ch4.lm1 <- lmer(ch4cmgm2hr ~ (1|sampleid) , data=ghg, REML=FALSE)

ch4.lm2 <- lmer(ch4cmgm2hr~hydrology + (1|sampleid), data=ghg, REML=TRUE)

ch4.lm3 <- lmer(ch4cmgm2hr~distance.bin + (1|sampleid), data=ghg, REML=FALSE)

ch4.lm4 <- lmer(ch4cmgm2hr~hydrology* distance.bin + (1|sampleid), data=ghg, REML=FALSE)

ch4.lm5 <- lmer(ch4cmgm2hr~season+ (1|sampleid), data=ghg, REML=FALSE)

ch4.lm6 <- lmer(ch4cmgm2hr~hydrology * season+ (1|sampleid), data=ghg, REML=FALSE)

ch4.lm7 <- lmer(ch4cmgm2hr~distance.bin* season+ (1|sampleid), data=ghg, REML=FALSE)

ch4.lm8 <- lmer(ch4cmgm2hr~hydrology* distance.bin * season * (1|sampleid), data=ghg, REML=FALSE)

#This is a liklihood ratio test to get Chi squared value and p-value
anova(ch4.lm1, ch4.lm2, ch4.lm3,ch4.lm4,ch4.lm5, ch4.lm6, ch4.lm7, ch4.lm8)
```

```{r CH4 by season, echo=T, out.width="100%"}

#boxplots
p <- ggplot(ghg) + 
  geom_boxplot(aes(x=season, y=ch4cmgm2hr, color=hydrology, shape=hydrology), outlier.shape=NA) +
  geom_point(aes(x=season, y=ch4cmgm2hr, color=hydrology, shape=hydrology), size=2, position = position_jitterdodge()) +
  scale_color_manual(name="Hydrology", values=colman, labels = hydro_label) +     
  #scale_shape_manual(name="Hydrology", values=c(17,21), labels = hydro_label) +       
  scale_x_discrete(labels=season_label,limits=c("sp", "sm", "f", "w")) + 
  labs(x = "", y = (expression(paste("CH"[4], " flux (mg C"," m"^-{2}," hr"^-{1},")")))) +
  ggtitle("") +
  #set Tukey groups from HSD.test above
  annotate("text",x=1.2,y=140, label="bc") +
  annotate("text",x=2.2,y=140, label="ab") +
  annotate("text",x=3.2,y=140, label="a") +
  annotate("text",x=4.2,y=140, label="a") +
  annotate("text",x=0.8,y=140, label="de") +
  annotate("text",x=1.8,y=420, label="e") + 
  annotate("text",x=2.8,y=290, label="de") + 
  annotate("text",x=3.8,y=170, label="cd") + 
  #set plot design
  theme_bw() + 
  theme(text  = element_text(size=20), panel.grid.major = element_blank(),  panel.grid.minor = element_blank(), axis.line = element_line(colour =  "black"),axis.title=element_text(size=20,face="bold"), axis.text=element_text(size=20), axis.text.x = element_text(size=20), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) +    
theme(legend.position="none")

p

getwd()

ggsave("../figures/CH4bySeason_ncasm.jpg", plot=p, device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)
```

```{r CO2 Quick visualization} 
ggplot(aes(x=sampleid, y=co2cmgm2hr, color=hydrology), data=ghg)+
  geom_violin(trim=FALSE) +
  facet_grid(~season)
#sqrt seems to unsquish them bit
ggplot(aes(x=sampleid, y=cbrt(co2cmgm2hr), color=hydrology), data=ghg)+
  geom_violin(trim=FALSE)+
  facet_grid(~season)
#maybe boxplots are not so bad in this case?
ggplot(aes(x=sampleid, y=co2cmgm2hr, color=hydrology), data=ghg)+
  geom_boxplot()+
  facet_grid(~season)
ggplot(aes(x=sampleid, y=co2cmgm2hr, color=hydrology), data=ghg)+
  geom_boxplot()
```

```{r CO2 Do we have normaility?}
#First check the distibution of residuals --- not so great
co2.lm <- lmer(co2cmgm2hr~(1|sampleid), data=ghg, REML=TRUE)
summary(co2.lm, ddf="Kenward-Roger")
confint(co2.lm)
p=profile(co2.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(co2.lm), main="QQ Plot")
shapiro.test(resid(co2.lm))
#Not too bad but 77 looks like an outlier
#Remove 77
ghg.77 <- ghg[-c(77),]
#check resdiuals now
co2.lm <- lmer(co2cmgm2hr~(1|sampleid), data=ghg.77, REML=TRUE)
summary(co2.lm, ddf="Kenward-Roger")
confint(co2.lm)
p=profile(co2.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(co2.lm), main="QQ Plot")
shapiro.test(resid(co2.lm))
#Not that much better

#Ok try square root first 
ghg$sqrt.co2 <- (sign(ghg$co2cmgm2hr) * sqrt(abs(ghg$co2cmgm2hr)))

co2.lm <- lmer(sqrt.co2~(1|sampleid), data=ghg, REML=TRUE)
summary(co2.lm, ddf="Kenward-Roger")
confint(co2.lm)
p=profile(co2.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(co2.lm), main="QQ Plot")
shapiro.test(resid(co2.lm))
#this is a lot better. but the xyplot is still a little off

ghg$cbrt.co2 <- cbrt(ghg$co2cmgm2hr)
#Try cuberoot - works with negative values
#This decreased variance in random effects, CI not 0, but still not normal or is it? 
co2.lm <- lmer(cbrt.co2~(1|sampleid), data=ghg, REML=TRUE)
summary(co2.lm, ddf="Kenward-Roger")
confint(co2.lm)
p=profile(co2.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(co2.lm), main="QQ Plot")
shapiro.test(resid(co2.lm))

#Since dataset still not normal... going to try log by first adding a constant to deal with < 0 values
m <- min(ghg$co2cmgm2hr)
ghg$log.co2 <- sign(ghg$co2cmgm2hr) * log(1 - m + ghg$co2cmgm2hr)

co2.lm <- lmer(log.co2~(1|sampleid), data=ghg, REML=TRUE)
summary(co2.lm, ddf="Kenward-Roger")
confint(co2.lm)
p=profile(co2.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(co2.lm), main="QQ Plot")
shapiro.test(resid(co2.lm))

m <- min(ghg$sqrt.co2)
ghg$log.sqrt.co2 <- sign(ghg$sqrt.co2) * log(1 - m + ghg$sqrt.co2)

co2.lm <- lmer(log.sqrt.co2~(1|sampleid), data=ghg, REML=TRUE)
summary(co2.lm, ddf="Kenward-Roger")
confint(co2.lm)
p=profile(co2.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(co2.lm), main="QQ Plot")
shapiro.test(resid(co2.lm))

#boxcox when non-normality is presistant
ghg$bc.ch4 <- boxCoxVariable(abs(ghg$ch4cmgm2hr))
ch4.lm <- lmer(bc.ch4~(1|sampleid), data=ghg, REML=TRUE)
summary(ch4.lm, ddf="Kenward-Roger")
confint(ch4.lm)
p=profile(ch4.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(ch4.lm), main="QQ Plot")
shapiro.test(resid(ch4.lm))

ghg$log.cb.co2 <- log(abs(cbrt(ghg$co2cmgm2hr)^(1/3)))

n2on.lm <- lmer(log.cb.co2~(1|sampleid), data=ghg, REML=TRUE)
summary(n2on.lm, ddf="Kenward-Roger")
confint(n2on.lm)
p=profile(n2on.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(n2on.lm), main="QQ Plot")
shapiro.test(resid(n2on.lm))

```
```{r Hypothesis testing log}
#Which factor/s (Hydrology, season, distance.bin) help explain GHG production?

#First I want to compare the randomness to parameters that I think might be influencing the response variable. In this case I want to know if hydrology, distance from the inlet, or season influence method production 
co2.lm1 <- lmer(log.cb.co2 ~ (1|sampleid) , data=ghg)

co2.lm2 <- lmer(log.cb.co2~hydrology + (1|sampleid), data=ghg)

co2.lm3 <- lmer(log.cb.co2~distance.bin + (1|sampleid), data=ghg)

co2.lm4 <- lmer(log.cb.co2~hydrology * distance.bin + (1|sampleid), data=ghg)

co2.lm4a <- lmer(log.cb.co2~hydrology + distance.bin + (1|sampleid), data=ghg)

co2.lm5 <- lmer(log.cb.co2~season+ (1|sampleid), data=ghg)

co2.lm6 <- lmer(log.cb.co2~hydrology * season+ (1|sampleid), data=ghg)

co2.lm6a <- lmer(log.cb.co2~hydrology + season+ (1|sampleid), data=ghg)

co2.lm7 <- lmer(log.cb.co2~distance.bin * season+ (1|sampleid), data=ghg)

co2.lm7a <- lmer(log.cb.co2~distance.bin + season+ (1|sampleid), data=ghg)

co2.lm8 <- lmer(log.cb.co2~hydrology * distance.bin * season + (1|sampleid), data=ghg)

co2.lm8a <- lmer(log.cb.co2~hydrology + distance.bin + season + (1|sampleid), data=ghg)

#This is a liklihood ratio test to get Chi squared value and p-value
anova(co2.lm1, co2.lm2, co2.lm3,co2.lm4,co2.lm5, co2.lm6, co2.lm7, co2.lm8)#, co2.lm4a, co2.lm6a, co2.lm7a, co2.lm8a)
#Large chi square test stat means data does not fit well, small chi data fits well

#AIC weights
c.mod <- list(co2.lm1, co2.lm2, co2.lm3,co2.lm4,co2.lm5, co2.lm6, co2.lm8)
Modnames <- c("null", "hydrology", "distance", "H*D", "season", "H*S", "H*D*S")
aictab(cand.set = c.mod, modnames = Modnames, second.ord = TRUE)


#Variance explained by fixed effects and the entire model
r.squaredGLMM(co2.lm1) #null
r.squaredGLMM(co2.lm2) #hydrology
r.squaredGLMM(co2.lm5) #season
r.squaredGLMM(co2.lm3) #distance bin
r.squaredGLMM(co2.lm6) #season * hydrology
r.squaredGLMM(co2.lm4) #season * distance
r.squaredGLMM(co2.lm8) #season * hydrology * distance.bin



#My conclusion is that hyrdology is the main factor influencing methane rates within the wetland

summary(co2.lm6, ddf="Kenward-Roger")
confint(co2.lm6)
p=profile(co2.lm6)
xyplot(p)
densityplot(p)
qqPlot(resid(co2.lm6), main="QQ Plot")
shapiro.test(resid(co2.lm6))

anova(co2.lm6a)

#Post hoc Tests
#Estimated marginal means - similar to lsmeans, uses t distribution
  emm <- emmeans(co2.lm6, ~ hydrology + season, adjust = "tukey")
  pairs(emm)
  multcomp::cld(emm, Letters=letters)

```
```{r CO2 by season, echo=T, out.width="100%"}

p <-ggplot(ghg) + 
  geom_boxplot(aes(x=season, y=ch4cmgm2hr, color=hydrology, shape=hydrology), outlier.shape=NA) +
  geom_point(aes(x=season, y=ch4cmgm2hr, color=hydrology, shape=hydrology), size=2, position = position_jitterdodge()) +
  scale_color_manual(name="Season", values=colman, labels = hydro_label) +     
  #scale_shape_manual(name="Hydrology", values=c(17,21), labels = hydro_label) +      
  scale_x_discrete(labels=season_label,limits=c("sp", "sm", "f", "w")) + 
  labs(x = "", y = (expression(paste("CO"[2], " flux (mg C"," m"^-{2}," hr"^-{1},")")))) +
  ggtitle("") +
  #set Tukey groups from HSD.test above
  annotate("text",x=0.8,y=125, label="b") +
  annotate("text",x=1.2,y=100, label="ab") +
  annotate("text",x=1.8,y=425, label="c") + 
  annotate("text",x=2.2,y=100, label="b") +
  annotate("text",x=2.8,y=295, label="b") +
  annotate("text",x=3.2,y=100, label="ab") + 
  annotate("text",x=3.8,y=165, label="ab") +
  annotate("text",x=4.2,y=100, label="a") + 
  #set plot design
  theme_bw() + 
  theme(text  = element_text(size=20), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line =   
          element_line(colour = "black"),axis.title=element_text(size=20,face="bold"), 
          axis.text=element_text(size=20), axis.text.x = element_text(size=20), panel.border = 
          element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm"))+        
          theme(legend.position="none")
p

ggsave("../figures/CO2bySeason_ncasm.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)
```

```{r n2on Quick visualization} 
ggplot(aes(x=sampleid, y=n2onmgm2hr, color=hydrology), data=ghg)+
  geom_violin(trim=FALSE) +
  facet_grid(~season)
#sqrt seems to unsquish them bit
ggplot(aes(x=sampleid, y=(n2onmgm2hr)^(1/3), color=hydrology), data=ghg)+
  geom_violin(trim=FALSE)+
  facet_grid(~season)
#maybe boxplots are not so bad in this case?
ggplot(aes(x=sampleid, y=n2onmgm2hr, color=hydrology), data=ghg)+
  geom_boxplot()+
  facet_grid(~season)
ggplot(aes(x=sampleid, y=n2onmgm2hr, color=hydrology), data=ghg)+
  geom_boxplot()
```

```{r n2on Do we have normality?}
#First check the distibution of residuals --- not so great
n2on.lm <- lmer(n2onmgm2hr~(1|sampleid), data=ghg, REML=TRUE)
summary(n2on.lm, ddf="Kenward-Roger")
confint(n2on.lm)
p=profile(n2on.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(n2on.lm), main="QQ Plot")
shapiro.test(resid(n2on.lm))

ghg$sqrt.n2o <- (sign(ghg$n2onmgm2hr) * (sqrt(abs(ghg$n2onmgm2hr))))

#Try square root first
n2on.lm <- lmer(sqrt.n2o~(1|sampleid), data=ghg, REML=TRUE)
summary(n2on.lm, ddf="Kenward-Roger")
confint(n2on.lm)
p=profile(n2on.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(n2on.lm), main="QQ Plot")
shapiro.test(resid(n2on.lm))

m <- min(ghg$n2onmgm2hr)
ghg$log.n2o <- sign(ghg$n2onmgm2hr) * log(1 - m + ghg$n2onmgm2hr)

n2on.lm <- lmer(log.n2o~(1|sampleid), data=ghg, REML=TRUE)
summary(n2on.lm, ddf="Kenward-Roger")
confint(n2on.lm)
p=profile(n2on.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(n2on.lm), main="QQ Plot")
shapiro.test(resid(n2on.lm))

ghg$cbrt.n2o <- cbrt(ghg$n2onmgm2hr)

#Try square root first
n2on.lm <- lmer(cbrt.n2o~(1|sampleid), data=ghg, REML=TRUE)
summary(n2on.lm, ddf="Kenward-Roger")
confint(n2on.lm)
p=profile(n2on.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(n2on.lm), main="QQ Plot")
shapiro.test(resid(n2on.lm))

ghg$log.cb.n2o <- log(abs(ghg$n2onmgm2hr)^(1/3))

n2on.lm <- lmer(log.cb.n2o~(1|sampleid), data=ghg, REML=TRUE)
summary(n2on.lm, ddf="Kenward-Roger")
confint(n2on.lm)
p=profile(n2on.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(n2on.lm), main="QQ Plot")
shapiro.test(resid(n2on.lm))

```
```{r Hypothesis testing log}
#Which factor/s (Hydrology, season, distance.bin) help explain GHG production?

#ANOVA is is not best here because it treats each observation as an independent observation but can not account for the randomness from sampling the same location. 
#Each sampling plot is measured for GHG monthly over 1 year (n=12). 

n2on.lm1 <- lmer(log.cb.n2o ~ (1|sampleid) , data=ghg)

n2on.lm2 <- lmer(log.cb.n2o~hydrology + (1|sampleid), data=ghg)

n2on.lm3 <- lmer(log.cb.n2o~distance.bin + (1|sampleid), data=ghg)

n2on.lm4 <- lmer(log.cb.n2o~hydrology * distance.bin + (1|sampleid), data=ghg)

n2on.lm5 <- lmer(log.cb.n2o~season+ (1|sampleid), data=ghg)

n2on.lm6 <- lmer(log.cb.n2o~hydrology * season+ (1|sampleid), data=ghg)

n2on.lm7 <- lmer(log.cb.n2o~distance.bin * season+ (1|sampleid), data=ghg)

n2on.lm8 <- lmer(log.cb.n2o~hydrology * distance.bin * season + (1|sampleid), data=ghg, )

#This is a liklihood ratio test to get Chi squared value and p-value
anova(n2on.lm1, n2on.lm2, n2on.lm3,n2on.lm4,n2on.lm5, n2on.lm6, n2on.lm7, n2on.lm8)

#AIC weights
c.mod <- list(n2on.lm1, n2on.lm2, n2on.lm3,n2on.lm4,n2on.lm5, n2on.lm6, n2on.lm8)
Modnames <- c("null", "hydrology", "distance", "H*D", "season", "H*S", "H*D*S")
aictab(cand.set = c.mod, modnames = Modnames, second.ord = TRUE)


#Variance explained by fixed effects and the entire model
r.squaredGLMM(n2on.lm1) #null
r.squaredGLMM(n2on.lm2) #hydrology
r.squaredGLMM(n2on.lm5) #season
r.squaredGLMM(n2on.lm3) #distance bin
r.squaredGLMM(n2on.lm6) #season * hydrology
r.squaredGLMM(n2on.lm4) #season * distance
r.squaredGLMM(n2on.lm8) #season * hydrology * distance.bin

summary(n2on.lm5, ddf="Kenward-Roger")
confint(n2on.lm5)
p=profile(n2on.lm5)
xyplot(p)
densityplot(p)
qqPlot(resid(n2on.lm5), main="QQ Plot")
shapiro.test(resid(n2on.lm5))

#Post hoc Tests
#Estimated marginal means - similar to lsmeans, uses t distribution
  emm <- emmeans(n2on.lm5, ~ season, adjust = "tukey")
  pairs(emm)
  multcomp::cld(emm, Letters=letters)
```
```{r N2O by season, echo=T, out.width="100%"}

p <- ggplot(ghg) + 
  geom_boxplot(aes(x=season, y=n2onmgm2hr, color=hydrology, shape=hydrology), outlier.shape=NA) +
  geom_point(aes(x=season, y=n2onmgm2hr, color=hydrology, shape=hydrology), size=2, position = position_jitterdodge()) +
  scale_color_manual(name="Season", values=colman, labels = hydro_label) +     
  #scale_shape_manual(name="Hydrology", values=c(17,21), labels = hydro_label) +      
  scale_x_discrete(labels=season_label,limits=c("sp", "sm", "f", "w")) + 
  labs(x = "", y = (expression(paste("N"[2],"O", " flux (mg N"," m"^-{2}," hr"^-{1},")")))) +
  ggtitle("") +
  #set Tukey groups from HSD.test above
  annotate("text",x=1,y=-1.25, label="____ab____") +
  annotate("text",x=2,y=-1.25, label="____b____") +
  annotate("text",x=3,y=-1.25, label="____ab____") +
  annotate("text",x=4,y=-1.25, label="____a____") +
  #set plot design
  theme_bw() + 
  theme(text  = element_text(size=20), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line =   
          element_line(colour = "black"),axis.title=element_text(size=20,face="bold"), 
          axis.text=element_text(size=20), axis.text.x = element_text(size=20), panel.border = 
          element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm"))+        
          theme(legend.position="bottom")
p

ggsave("../figures/N2ObySeason_ncasm.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)
```

```{r soil_sediment parameters}
#First sediment parameters. There are GHG fluxes and sediment properties for 4 timepoints (May, Aug, Oct, Dec)
#Filter ghg dataset to include only sampling points with soil variables
ghg.soil <- ghg %>%
  filter(date=="5/18/2017" | date=="7/26/2017" | date=="10/18/2017" | date=="12/14/2017")

#Remove correlated variables first.... fix subsetting
#Look for pairings close to 1 and remove...
cor(ghg.soil[,-c(1:28, 30:31, 41:56)])
#correlation()
##Remove c.percent and n.percent. Correlates well with each otehr and the organic matter

```


```{r }

#Maybe methane and carbon dixoide are highly corrleated especially in flooded plots
g <- ggplot(aes(x=ch4cgm2day, y=co2cgm2day, color = hydrology), data=ghg) +
  geom_point()+
  geom_smooth()

ghg.filter <- ghg %>%
  filter(hydrology=="PI")

corr_spearman <- cor.test(x=ghg.filter$ch4cgm2day, y=ghg.filter$co2cgm2day, method = 'spearman')
corr_spearman 
corr_kendall <- corr <- cor.test(x=ghg.filter$ch4cgm2day, y=ghg.filter$co2cgm2day, method = 'kendall')
corr_kendall
corr_pearson <- corr <- cor.test(x=ghg.filter$ch4cgm2day, y=ghg.filter$co2cgm2day, method = 'pearson')
corr_pearson

```
#DENITRIFICATION ENZYME ASSAY
```{r read in data}
#CSW DEA data
DEA <- read.csv("../data/CSW_DEA_Env.csv", header=T)

```

```{r DEA with acetylene, echo=T, out.width="100%"}
#Normaility Check
DEA <- DEA[-c(119),]

min(DEA[,c(13)])
max(DEA[,c(13)])

y.n2on.lm <- lmer(y.ng.N2ON.hr.gdw~(1|sampleid), data=DEA, REML=TRUE)
summary(y.n2on.lm, ddf="Kenward-Roger")
confint(y.n2on.lm)
p=profile(y.n2on.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(y.n2on.lm), main="QQ Plot")
shapiro.test(resid(y.n2on.lm))


DEA$log.n2o <- log(DEA$y.ng.N2ON.hr.gdw)

n2on.lm <- lmer(log.n2o~(1|sampleid), data=DEA, REML=TRUE)
summary(n2on.lm, ddf="Kenward-Roger")
confint(n2on.lm)
p=profile(n2on.lm)
xyplot(p)
densityplot(p)
qqPlot(resid(n2on.lm), main="QQ Plot")
shapiro.test(resid(n2on.lm))

```
```{r Y.DEA}

DEA.lm1 <- lmer(log.n2o ~ (1|sample), data=DEA, REML=TRUE)

DEA.lm2 <- lmer(log.n2o~hydrology + (1|sample), data=DEA, REML=TRUE)

DEA.lm3 <- lmer(log.n2o~distance.bin + (1|sample), data=DEA, REML=FALSE)

DEA.lm4 <- lmer(log.n2o~hydrology * distance.m + (1|sample), data=DEA, REML=FALSE)

DEA.lm5 <- lmer(log.n2o~season+ (1|sample), data=DEA, REML=FALSE)

DEA.lm6 <- lmer(log.n2o~hydrology * season+ (1|sample), data=DEA, REML=FALSE)

DEA.lm7 <- lmer(log.n2o~distance.bin * season+ (1|sample), data=DEA, REML=FALSE)

DEA.lm8 <- lmer(log.n2o~hydrology * distance.m * season + (1|sample), data=DEA, REML=FALSE)

#DEA.lm9 <- lmer(log.n2o~ moist.percent + (1|sample), data=DEA, REML=FALSE)

#This is a liklihood ratio test to get Chi squared value and p-value
anova(DEA.lm1, DEA.lm2, DEA.lm3,DEA.lm4,DEA.lm5, DEA.lm6, DEA.lm7, DEA.lm8) #, DEA.lm9)

summary(DEA.lm5, ddf="Kenward-Roger")
confint(DEA.lm5)
p=profile(DEA.lm5)
xyplot(p)
densityplot(p)
qqPlot(resid(DEA.lm5), main="QQ Plot")
shapiro.test(resid(DEA.lm5))

#Post hoc Tests
#Estimated marginal means - similar to lsmeans, uses t distribution
 require("emmeans")
 emm <- emmeans(DEA.lm5, ~ season, adjust = "tukey")
  pairs(emm)
  multcomp::cld(emm, Letters=letters)

```

```{r visualize y.DEA}
#hydro_label <- c("flooded wetland", "upland")
p <- ggplot(DEA) + 
  geom_boxplot(aes(x=season, y=(y.ng.N2ON.hr.gdw), color=hydrology, shape=hydrology), outlier.shape=NA) +
  geom_point(aes(x=season, y=(y.ng.N2ON.hr.gdw), color=hydrology, shape=hydrology), size=2, position = position_jitterdodge()) +
      scale_color_manual(name="Hydrology", values=c("blue", "chartreuse4"), labels = hydro_label) + 
      scale_x_discrete(labels=c("1spring" = "spring", "2summer" = "summer", "3fall" = "fall", "4winter" = "winter")) +
  annotate("text",x=1.5,y=85, label="____________a____________") +
  annotate("text",x=3.5,y=65, label="____________b____________") + 

  theme_bw() + theme(text  = element_text(size=16), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) + 
      theme(axis.title=element_text(vjust=1,size=16,face="bold"), axis.text=element_text(size=16), axis.text.x = element_text(vjust=0.65, hjust=0.5, size=20), panel.border = element_rect(colour = "black",size=1)) +   
      theme(axis.ticks.length=unit(0.3,"cm")) + 
      labs(x = "", y = (expression(paste("N"[2],"O Potential Rate (ng N hr"^-{1}," g-soil"^-{1},")")))) +   
      theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=16, face="bold"),
              strip.background = element_rect(colour="black", fill="white", size=1)) +
      theme(legend.title=element_text(size=20),legend.text=element_text(size=14)) +
  theme(legend.position = "none") 
p

ggsave("../figures/DEApotential_ncasm.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)

```
```{r old DEA}
#Quick Data Summary
ghg.summary <- DEA %>%
  group_by(hydrology)%>%
  dplyr::summarise(mean_y.ng.N2ON.hr.gdw=mean(y.ng.N2ON.hr.gdw), sd_y.ng.N2ON.hr.gdw=sd(y.ng.N2ON.hr.gdw))

ghg.summary

ghg.summary <- ghg %>%
  group_by(hydrology, num.days.last.rain)%>%
  dplyr::summarise(mean_ch4cmgm2hr=mean(ch4cmgm2hr), sd_ch4cmgm2hr=sd(ch4cmgm2hr),mean_co2cmgm2hr=mean(co2cmgm2hr), sd_co2cmgm2hr=sd(co2cmgm2hr),mean_n2onmgm2hr=mean(n2onmgm2hr), sd_n2onmgm2hr=sd(n2onmgm2hr))

ghg.summary

ghg.summary <- ghg %>%
  group_by(hydrology, distance.bin)%>%
  dplyr::summarise(mean_ch4cmgm2hr=mean(ch4cmgm2hr), sd_ch4cmgm2hr=sd(ch4cmgm2hr),mean_co2cmgm2hr=mean(co2cmgm2hr), sd_co2cmgm2hr=sd(co2cmgm2hr),mean_n2onmgm2hr=mean(n2onmgm2hr), sd_n2onmgm2hr=sd(n2onmgm2hr))

ghg.summary

ghg.summary <- ghg %>%
  group_by(hydrology, season)%>%
  dplyr::summarise(mean_ch4cmgm2hr=mean(ch4cmgm2hr), sd_ch4cmgm2hr=sd(ch4cmgm2hr),mean_co2cmgm2hr=mean(co2cmgm2hr), sd_co2cmgm2hr=sd(co2cmgm2hr),mean_n2onmgm2hr=mean(n2onmgm2hr), sd_n2onmgm2hr=sd(n2onmgm2hr))

ghg.summary

#CH4
min(ghg$ch4cmgm2hr)
max(ghg$ch4cmgm2hr)
#CO2
min(ghg$co2cmgm2hr)
max(ghg$co2cmgm2hr)
#N2O
min(ghg$n2onmgm2hr)
max(ghg$n2onmgm2hr)
```

```{r DEA with no acetylene, echo=T, out.width="100%"}
#linear model for no acetylene/ yes acetylene DEA ratio
DEA.lm <- lm(n.ng.N2ON.hr.gdw~hydrology*season,data=DEA)
plot(DEA.lm)
anova(DEA.lm)

p <- ggplot(DEA, aes(x=season, y=n.ng.N2ON.hr.gdw, color=as.factor(hydrology), shape=as.factor(hydrology))) + 
      geom_boxplot() + geom_point(aes(color=factor(hydrology)), size=2, position = position_jitterdodge())  + 
      scale_color_manual(name="Hydrology", values=c("navy","darkgreen"), labels = hydro_label) + 
      scale_shape_manual(name="Hydrology", values=c(17,21), labels = c("flooded wetland", "upland")) + 
      scale_x_discrete(labels=c("1spring" = "spring", "2summer" = "summer", "3fall" = "fall", "4winter" = "winter"))
p1 <- p + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=16,face="bold"), axis.text=element_text(size=16), axis.text.x = element_text(vjust=0.65, hjust=0.5, size=16), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Season", y = (expression(paste("Denitrification Rate (ng N"[2],"O g"^-{1}," DM hr"^-{1},")")))) + theme(strip.text.x = element_text(size=16, face="bold"), strip.text.y = element_text(size=16, face="bold"), strip.background = element_rect(colour="black", fill="white", size=1))+ theme(legend.title=element_text(size=14),legend.text=element_text(size=14))
p1

ggsave("../figures/DEApotential_NOacetylene.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)

```

```{r DEA ratio, echo=T, out.width="100%"}
#linear model for no acetylene/ yes acetylene DEA ratio
ratio.lm <- lm(rN2O_N2O.N2~hydrology*season,data=DEA)
plot(ratio.lm)
anova(ratio.lm)

p <- ggplot(DEA, aes(x=season, y=rN2O_N2O.N2, color=as.factor(hydrology), shape=as.factor(hydrology))) +
      geom_boxplot() + geom_point(aes(color=factor(hydrology)), size=2, position = position_jitterdodge()) + 
      scale_color_manual(name="Hydrology", values=c("navy","darkgreen"), labels = hydro_label) + 
      scale_shape_manual(name="Hydrology", values=c(17,21), labels = hydro_label) + 
      scale_x_discrete(labels=c("1spring" = "spring", "2summer" = "summer", "3fall" = "fall", "4winter" = "winter"))
p1 <- p + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = 
              element_line(colour = "black")) +
      theme(axis.title=element_text(vjust=1,size=16,face="bold"), axis.text=element_text(size=18), axis.text.x = 
              element_text(vjust=0.65, hjust=0.5, size=18), panel.border = element_rect(colour = "black",size=1)) + 
      theme(axis.ticks.length=unit(0.3,"cm")) + 
              labs(x = "Season", y = (expression(paste("rate(N"[2],"O)/rate(N"[2],"O+N"[2],")")))) + 
      theme(strip.text.x = element_text(size=18, face="bold"), 
              strip.text.y = element_text(size=18, face="bold"), 
              strip.background = element_rect(colour="black", fill="white", size=1)) +   
      theme(legend.title=element_text(size=14),legend.text=element_text(size=14))
p1

ggsave("../figures/DEAratio.jpeg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)
```

```{r DEA with acetylene by sample plot, echo=T, out.width="100%"}
#linear model for no acetylene/ yes acetylene DEA ratio
i <- with(DEA, interaction(hydrology,season))
DEA.lm <- lm(log(y.ng.N2ON.hr.gdw)~hydrology+season+i,data=DEA)
plot(DEA.lm)
anova(DEA.lm)

#Get Tukey post hoc groups p<=0.01*
t <- HSD.test(DEA.lm, "i", group=TRUE, alpha=.05)
t
plot(t)

p <- ggplot(DEA, aes(x=sample, y=n.ng.N2ON.hr.gdw, color=as.factor(hydrology), shape=as.factor(hydrology))) + stat_summary(fun.data=mean_cl_boot,size=0.75, position=position_dodge(width=0.3)) + scale_color_manual(name="Hydrology", values=c("darkgreen","navy"), labels = c("terrestrial", "inundated")) + scale_shape_manual(name="Hydrology", values=c(16,17), labels = c("terrestrial", "inundated")) +facet_wrap(~season) 
p + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=16,face="bold"), axis.text=element_text(size=16), axis.text.x = element_text(vjust=0.65, hjust=0.5, angle=45, size=8), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Sample Location", y = (expression(paste("Denitrification Rate (ng N"[2],"O g"^-{1}," DM hr"^-{1},")")))) + theme(strip.text.x = element_text(size=16, face="bold"), strip.text.y = element_text(size=16, face="bold"), strip.background = element_rect(colour="black", fill="white", size=1))+ theme(legend.title=element_text(size=14),legend.text=element_text(size=14))

ggsave("../figures/DEApotential_location.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)
```

```{r CO2 equivalents}
#What do I want to show with CO2 Equiv? 
#In wetland... where is most C being lost? PI or SL 
#As CO2 and CH4... N2O may be better thought about in the context of denitrification
#Relate this to the percent cover of each type of wetland


#This is the annual amount of C stored or released from PI or SL plots yearly
#First get average of all plots by hyrdology and season in mg C m2 hr
ghg.co2.equiv <- ghg #%>% 
  #filter(month=="5-May"| month=="7-Jul" |month == "10-Oct"| month=="12-Dec")

#This code was previously used to upscale Carbon dioxide equivalents to whole wetland
#%>%
#  group_by(hydrology, month) %>%
#  summarise(mch4mgm2hr=mean(ch4cmgm2hr),mco2mgm2hr=mean(co2cmgm2hr),mn2omgm2hr=mean(n2onmgm2hr)) %>%
  #Then multiple mg C m2 hr * 24 * 365 = mg C m2 yr
#  mutate(ch4mgcm2yr = mch4mgm2hr * 8760/1000/1000, co2mgcm2yr = mco2mgm2hr*8760/1000/1000, n2omgnm2yr=mn2omgm2hr*8760/1000/1000) %>%
#  mutate(ch4mgcyr=0, co2mgcyr=0, n2omgnyr=0)%>%
 #Then multiple each gas (ch4mgcyrco2, n2omgnyrco2, co2mgcyr) 
  #by percent PI (65%) and percent SL (35%) of 5600sq ft converted to m2 (520...)
#  mutate(ch4mgcyr=ifelse(hydrology=="PI", ch4mgcm2yr*338.167, ch4mgcm2yr * 182.09)) %>% mutate(co2mgcyr=ifelse(hydrology=="PI", co2mgcm2yr*338.167, co2mgcm2yr * 182.09)) %>% mutate(n2omgnyr=ifelse(hydrology=="PI", n2omgnm2yr*338.167, n2omgnm2yr * 182.09))%>%
  #Take that amount of mg C yr and multiple by CO2 Equivalents
  
  ####change to mg m2 hr....
#  mutate(ch4mgcyrco2 = ch4mgcyr*34, n2omgnyrco2=n2omgnyr *298)
  
g <- ghg.co2.equiv %>%
   group_by(hydrology, month) %>%
  summarise(mch4co2=mean(ch4co2eq), sdch4co2=sd(ch4co2eq), mco2 = mean(co2cmgm2hr), sdco2 = sd(co2cmgm2hr), mn2oco2 = mean(n2oco2eq), sdn2oco2=sd(n2oco2eq))
 
wide_to_long <- gather(g, co2eq, measurement, mch4co2, mco2, mn2oco2, factor_key=TRUE)  
#wide_to_long <- gather(wide_to_long, sd, measurement, sdch4co2, sdco2, sdn2oco2, factor_key=TRUE)
wide_to_long

totc <- summarise(wide_to_long, s = sum(measurement))
totc$s
#PI 98.86%
#8958
#SL 1.14%
#104
#Total C in = 9071 kg C year


levels(wide_to_long$hydrology) 
levels(wide_to_long$hydrology) <- c("Flooded","Shallow land")

flooded_only <- wide_to_long %>%
  filter(hydrology=="Flooded") %>%
  filter(co2eq != "mn2oco2")

p <-ggplot(flooded_only, aes(x=month, y=measurement, fill=co2eq)) + geom_bar(stat="identity") + scale_fill_brewer(palette="OrRd") +
  #facet_wrap(~hydrology) +
  #geom_hline(yintercept=0, linetype="dashed", color="black", size=1) +
  scale_x_discrete(labels=c("Jan", "Feb", "Mar", "Apr", "May","Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), limits=c("1-Jan", "2-Feb", "3-Mar", "4-Apr", "5-May", "6-Jun", "7-Jul", "8-Aug", "9-Sep", "10-Oct","11-Nov", "12-Dec")) +
  scale_fill_manual(labels=c("CH4-C","CO2-C"), values=c("grey", "black")) + 
  #scale_x_discrete(labels=c("sp" = "spring", "sm" = "summer", "f" = "fall", "w" = "winter"), limits=c("sp", "sm", "f", "w")) + labs(x = "Season", y = (expression(paste("Total Annual Carbon (kg)")))) 

  labs(x = "", y = (expression(paste("CO"[2], " mg m"^-{2}, "hr"^{-1})))) +
  facet_wrap(~hydrology) + 
theme_bw() + theme(text=element_text(size=16), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) + theme(legend.position = "none") + theme(axis.title=element_text(vjust=1,size=16), axis.text=element_text(size=16), axis.text.x = element_blank(), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + theme(strip.text.x = element_text(size=16), strip.text.y = element_text(size=16), strip.background = element_rect(colour="black", fill="white", size=1)) 

p

ggsave("../figures/CO2equiv_mean_mg.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)

ggsave("../figures/CO2equiv_mean_mg.jpeg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=8, height=4, dpi=300, limitsize=TRUE)

ghg.co2.equiv.sl <- wide_to_long %>%
  filter(hydrology == "Shallow land")%>%
  filter(co2eq != "mn2oco2")

p <-ggplot(ghg.co2.equiv.sl, aes(x=month, y=measurement, fill=co2eq)) + geom_bar(stat="identity") + facet_wrap(~hydrology) + 
  #geom_hline(yintercept=0, linetype="dashed", color="black", size=1) +
scale_x_discrete(labels=c("Jan", "Feb", "Mar", "Apr", "May","Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), limits=c("1-Jan", "2-Feb", "3-Mar", "4-Apr", "5-May", "6-Jun", "7-Jul", "8-Aug", "9-Sep", "10-Oct","11-Nov", "12-Dec")) + 
  scale_fill_manual(labels=c("CH4-CO2","CO2-CO2"), values=c("grey", "black")) + 
  #scale_x_discrete(labels=c("sp" = "spring", "sm" = "summer", "f" = "fall", "w" = "winter"), limits=c("sp", "sm", "f", "w")) + 
  labs(x = "", y = (expression(paste("CO"[2], " mg m"^-{2}, "hr"^{-1})))) +   
  guides(fill=guide_legend(title=(expression(paste("CO"[2], " Equivalency"))))) + 

theme_bw() + theme(text=element_text(size=16), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) + theme(legend.position = "bottom") + theme(axis.title=element_text(vjust=1,size=16), axis.text=element_text(size=16), axis.text.x = element_text(vjust=0.65, hjust=0.5, size=16), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + theme(strip.text.x = element_text(size=16), strip.text.y = element_text(size=16), strip.background = element_rect(colour="black", fill="white", size=1)) 

p

ggsave("../figures/CO2equiv_JustSL_mean_mg.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)

ggsave("../figures/CO2equiv_JustSL_mean_mg.jpeg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=8, height=4, dpi=300, limitsize=TRUE)
```


```{r CO2:CH4  by season, echo=T, out.width="100%"}
#linear model for methane
#remove outlier spring co2_ch4 >8000
ghg.ratio <- subset(ghg, co2_ch4<6000)
i <- with(ghg.ratio, interaction(hydrology,season))
ghg.lm <- aov(co2_ch4~hydrology+season+i,data=ghg.ratio)
plot(ghg.lm)
anova(ghg.lm)
#i <- with(ghg, interaction(hydrology,season))
#ghg.lm <- lm(co2_ch4~hydrology+season+i,data=ghg)
#plot(ghg.lm)
#anova(ghg.lm)

summary(ghg.lm)

t <- HSD.test(ghg.lm, "i", group=TRUE, alpha=0.05)
t
plot(t)

p <- ggplot(ghg.ratio, aes(x=season, y=co2_ch4, color=season, shape=hydrology))+ geom_boxplot() +
  geom_point(aes(color=factor(season)), size=2, position = position_jitterdodge()) +  
  scale_color_manual(name="Season", values=colseason, labels = season_label) +     
  scale_shape_manual(name="Hydrology", values=c(17,21), labels = hydro_label) +      
  scale_x_discrete(labels=season_label,limits=c("sp", "sm", "f", "w")) + 
  labs(x = "Season", y = (expression(paste("CO"[2],": CH"[4])))) +
  ggtitle("Seasonal carbon dioxide:methane ratio") +

  #set plot design
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line =   
          element_line(colour = "black"),axis.title=element_text(size=12,face="bold"), 
          axis.text=element_text(size=12), axis.text.x = element_text(size=12), panel.border = 
          element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm"))
p

ggsave("../figures/co2_ch4Season.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)
```

```{r read in sequence data}
#Read in design file
meta <- read.csv("../data/CSW_16S_design.csv", row.names=1)
#Read in OTU file
otu <- read.otu("../data/csw2017.opti_mcc_withArchaea.shared")

# Import Taxonomy File
tax <- read.tax(taxonomy = "../data/csw2017.opti_mcc.0.03.cons_withArchaea.taxonomy",
                   format = "rdp", tax.levels = 6, col.tax = 3)

#tax <- read.tax(taxfile)
#read.tax does not work and I was unable to solve issue. I use phyloseq import_mothur as a work around. #there was no 'bin' folder with MothurTools
#tax <- import_mothur(mothur_constaxonomy_file =  taxfile)
tax.df <- as.data.frame(tax)
colnames(tax.df)=c("otu","Domain","Phylum","Class", "Order","Family","Genus")
tax <- tax_table(tax.df)
#tax

#Remove OTUs with less than 2 occurences across all sites
otu.2 <- otu[, which(colSums(otu) > 2)]
#colnames(otu.2)
#rownames(otu.2)

#What sample has lowest read count? 
otu2<- colSums(t(otu.2))
#otu2
otu2[which.min(colSums(t(otu.2)))]
otu2[which.max(colSums(t(otu.2)))]

#graph of read counts, need to work on y axis
c<-as.data.frame(otu.2)
c$colsum <- colSums(t(c))
c$group <- rownames(c)
p<-ggplot(c, aes(x=group,y=colsum))+geom_bar(stat="identity")+coord_flip()
p

#Rarefy
#Set min sample number
min.N <- min(rowSums(otu.2))
#rrarefy returns a randomly rarefied community data frame or vector of selected size
#This is the otu set that should be used for beta diversity metrics
otu.rare <- rrarefy(otu.2, min.N)

```

```{r rarefaction curve}
#rarefy returns a species richness estimate in a random subsample of selected size
otu.rare.rich <- rarefy(x = otu.2, sample=min.N, se=T)
#Plot rarefaction curve
###I am not sure how to interpret this. I think it suggests that I did not capture all of the diversity? AP response: Yes, when the collector's curve is still increasing, then if we sampled more deeply, there would still be new OTUs sampled
rarecurve(x = otu.2, step = 20, col="blue", cex=0.6, las=1)
abline(0,1,col='red')
text(10000,10000,"1:1",pos=2, col='red')

```

```{r Relative abundance and PERMANOVA }
#transforms read counts to relative abundance
#Using rarefied OTU dataset
otu.2.rel <- otu.2
for(i in 1:dim(otu.2)[1]){
  otu.2.rel[i,] <- otu.2[i,]/sum(otu.2[i,])
}

bc_alpha <- diversity(otu.2.rel, "shannon")
bc_PA <- decostand(otu.2.rel, method = "pa", na.rm=TRUE)
bc_rich <- specnumber(bc_PA)

bc_div <- cbind(meta, bc_alpha)
bc_div <- cbind(bc_div, bc_rich)

#Combine experimental deisng meta data with OTU relative abundance data
metaotu <- cbind(meta, otu.2.rel)
#Where does otu data begin, remove for PERMANOVA
#metaotu[1:5, c(1:5)]

#PERMANOVA with plant and Treatment as factors
#Among all treatments plant (soil source) and treatment
metaotu.ad <- adonis(metaotu[,-c(1:4)] ~treatment*season, method = "bray", data = metaotu, perm=1000, set.seed=42)
metaotu.ad 

```

```{r visualize}

#hydro_label <- c("flooded wetland", "upland")
p <- ggplot(bc_div) + 
  geom_boxplot(aes(x=season, y=(bc_alpha), color=treatment, shape=treatment), outlier.shape=NA) +
  geom_point(aes(x=season, y=(bc_alpha), color=treatment, shape=treatment), size=2, position = position_jitterdodge()) +
      scale_color_manual(name="Hydrology", values=c("blue", "chartreuse4"), labels = hydro_label) + 
      scale_x_discrete(labels=c("1spring" = "spring", "2summer" = "summer", "3fall" = "fall", "4winter" = "winter")) +
  #annotate("text",x=1.5,y=85, label="____________a____________") +
  #annotate("text",x=3.5,y=65, label="____________b____________") + 

  theme_bw() + theme(text  = element_text(size=16), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) + 
      theme(axis.title=element_text(vjust=1,size=16,face="bold"), axis.text=element_text(size=16), axis.text.x = element_text(vjust=0.65, hjust=0.5, size=20), panel.border = element_rect(colour = "black",size=1)) +   
      theme(axis.ticks.length=unit(0.3,"cm")) + 
      labs(x = "", y = (expression(paste("Bacterial Shannon H' Diversity")))) +   
      theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=16, face="bold"),
              strip.background = element_rect(colour="black", fill="white", size=1)) +
      theme(legend.title=element_text(size=20),legend.text=element_text(size=14)) +
  theme(legend.position = "none") 
p

ggsave("../figures/rich.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)

```

```{r visualize richness}

#hydro_label <- c("flooded wetland", "upland")
p <- ggplot(bc_div) + 
  geom_boxplot(aes(x=season, y=(bc_rich), color=treatment, shape=treatment), outlier.shape=NA) +
  geom_point(aes(x=season, y=(bc_rich), color=treatment, shape=treatment), size=2, position = position_jitterdodge()) +
      scale_color_manual(name="Hydrology", values=c("blue", "chartreuse4"), labels = hydro_label) + 
      scale_x_discrete(labels=c("1spring" = "spring", "2summer" = "summer", "3fall" = "fall", "4winter" = "winter")) +
  #annotate("text",x=1.5,y=85, label="____________a____________") +
  #annotate("text",x=3.5,y=65, label="____________b____________") + 

  theme_bw() + theme(text  = element_text(size=16), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) + 
      theme(axis.title=element_text(vjust=1,size=16,face="bold"), axis.text=element_text(size=16), axis.text.x = element_text(vjust=0.65, hjust=0.5, size=20), panel.border = element_rect(colour = "black",size=1)) +   
      theme(axis.ticks.length=unit(0.3,"cm")) + 
      labs(x = "", y = (expression(paste("Bacterial Richness")))) +   
      theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=16, face="bold"),
              strip.background = element_rect(colour="black", fill="white", size=1)) +
      theme(legend.title=element_text(size=20),legend.text=element_text(size=14)) +
  theme(legend.position = "none") 
p

ggsave("../figures/rich.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)

```


```{r Calculate distance matrix and PCoA components }

otu.2.rel.dist<-vegdist(otu.2.rel, method="bray")

head(otu.2.rel.dist)

# Principal Coordinates Analysis
otu.2.rel.dist.pcoa <- cmdscale(otu.2.rel.dist, k=3, eig=TRUE, add=FALSE)
# Classical (Metric) Multidimensional Scaling; returns PCoA coordinates
# eig=TRUE returns eigenvalues; k = # of dimensions to calculate

explainvar1a <- round(otu.2.rel.dist.pcoa$eig[1] / sum(otu.2.rel.dist.pcoa$eig), 3) * 100
explainvar2a <- round(otu.2.rel.dist.pcoa$eig[2] / sum(otu.2.rel.dist.pcoa$eig), 3) * 100
sum.eiga <- sum(explainvar1a, explainvar2a)

explainvar1a
explainvar2a

```

```{r PCoA Plot }
#all.equal(rownames(meta), rownames(otu.2.rel))
# Set treatments
treat1 <- as.factor(meta$month)
levels(treat1) <- ordered(c("May","October"))
treat2 <- as.factor(meta$treatment)
levels(treat2) <- c("flooded wetland", "upland")

pcoa.groups <- paste(meta$month, meta$treatment, sep = "_")
pcoa.points <- data.frame(otu.2.rel.dist.pcoa$points, group = pcoa.groups)

# Calculate Centroids (mean and SE)
pcoa.L.centroids <- melt(pcoa.points, id="group", measure.vars = c("X1", "X2"))
pcoa.centroids <- acast(pcoa.L.centroids, variable ~ group, mean)
pcoa.centroids.se <- acast(pcoa.L.centroids, variable ~ group, se)
pcoa.centroids.sd <- acast(pcoa.L.centroids, variable ~ group, sd)

# Combine - updated
# Combine
pcoa.cent.dataframe <- cbind(t(pcoa.centroids), t(pcoa.centroids.se))
colnames(pcoa.cent.dataframe) <- c("V1", "V2", "V1e", "V2e")
pcoa.cent.treats <- rownames(pcoa.cent.dataframe)
trt.month <- c("May","May","October","October")
trt.location <- c("flooded wetland", "upland","flooded wetland", "upland")
pcoa.cent.dataframe.trts <- as.data.frame(pcoa.cent.dataframe)
pcoa.cent.dataframe.trts$month <- as.factor(trt.month)
pcoa.cent.dataframe.trts$location <- as.factor(trt.location)

meta.env <- design %>% 
dplyr::select(ddate, month,sampleid, hydrology, season, moist.percent, ph, om.percent, nh4n.mg.gdw, no3n.mg.gdw, c.percent, n.percent, c.n)%>%
  filter(ddate=='5/16/2017' | ddate=='10/15/2017') %>%
  filter(sampleid %in% c('01W', '02W','03W', '04W','05W','07T', '08T','09T','11T', '12T', '13T'))

fit<-envfit(otu.2.rel.dist.pcoa$points, ghg.soil.bac, perm=1000, na.rm=T, set.seed=42)

A <-as.list(fit$vectors)
vec<-as.data.frame(fit$vectors$arrows*sqrt(fit$vectors$r)*0.35)
p<- as.data.frame(A$pvals)
#vec <- cbind(vec, p) 
#vec <-  subset(vec, A$pvals<=0.05)

#vec$parm<-rownames(vec)
#colnames(vec)

####None of the soil parameters were significant predictors of bacterial community beta diversity

#plot PCoA
df1a <- as.data.frame(pcoa.cent.dataframe.trts)
plot1 <- ggplot(df1a, aes(x=V1, y=V2,  color=location, shape = month),
                 group = interaction(month, location)) + theme_bw()  + 
    geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e, height=0.02), colour="black") +    
  geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e, width=0.02), colour="black") + 
  geom_point(aes(shape = month, colour = location), size=7) + 
#removes gridlines from plot
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
#Set colors for treatments
  scale_colour_manual(labels = hydro_label, 
                    values = c("blue", "chartreuse4")) + 
  scale_shape_manual(labels = c("May", "October"), 
                   values = c(16,15)) +
#Sets map coordinates
  coord_cartesian(xlim = c(-0.3, 0.3), ylim = c(-0.3, 0.3)) +
#Sets axis text and put border around plot
  theme(axis.title = element_text(size=20), 
        axis.text.x = element_text(size=20),  axis.text.y = element_text(size=20),
        panel.border = element_rect(colour = "black", size=1.25)) +
  #Set plot title textsize
  theme(plot.title=element_text(size=20)) +
  #Set legend text size
  theme(legend.text=element_text(size=20), legend.title = element_text(size=20))+
  #Sets size of tick marks on axis
  theme(axis.ticks.length=unit(0.3,"cm")) + 
  #Sets labels for plot title, axis titles, and legend headings
  xlab("PCoA 1 (17.4%)") + ylab("PCoA 2 (13.0%)") + 
  labs(shape = "Month") +
  labs(colour="Location") +
  ggtitle("16S rRNA V4 Microbial Composition") 
  
plot1 

#Save a copy of the plot
ggsave("../figures/CSW_PCoA.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=8.7, height=6.3, dpi=900, limitsize=TRUE)

```

```{r dbplsr analysis}
#distance based partial least squares regression
#Compares distance matrices. can use mixture of continuous and qualitative variables. 
#Method good when factors are may and highly colinear. A PLS model find the multidimensional direction in the Z space that explains the vairance in the Y space. 

#dbplsr(otu matrix, soil matrix)
#To do this I think I neet to first restrict soil to motnhs and plots have bacterial data for 
#Then create a euclidan distance matrix...
#MAY, OCT 1W-5W, 7T-9T, 11T-13T
ghg.soil.bac <- ghg %>%
  filter(date=="5/18/2017" | date=="10/18/2017") %>%
  filter(sampleid %in% c('01W', '02W','03W', '04W','05W','07T', '08T','09T','11T', '12T', '13T'))

#Remove correlated variables first.... fix subsetting
#Look for pairings close to 1 and remove...
cor(ghg.soil.bac[,-c(1:28, 30:31, 35:36,41:57)])
correlation(ghg.soil.bac[,-c(1:28, 30:31, 35:36,41:57)])

ghg.soil.bac.filter <- ghg.soil.bac[,-c(1:9, 13:20, 26:28, 30:31, 34:35,38:39, 41:57)]
ghg.soil.bac.filter 
  
#Filter in same order as otu distance matrix
ghg.soil.bac.filter <- ghg.soil.bac.filter %>%
    dplyr::arrange(sampleid, desc(month))


#Are GHG 
dbplsr.ch4 <- dbplsr(ghg.soil.bac.filter$ch4cmgm2hr ~ as.matrix(otu.2.rel.dist), data=ghg.soil.bac.filter , ncomp=3, method="GCV")
summary(dbplsr.ch4)

dbplsr.co2 <- dbplsr(ghg.soil.bac.filter$co2cmgm2hr ~ as.matrix(otu.2.rel.dist), data=ghg.soil.bac.filter , ncomp=3, method="GCV")
summary(dbplsr.co2)

dbplsr.n2o <- dbplsr(ghg.soil.bac.filter$n2onmgm2hr ~ as.matrix(otu.2.rel.dist), data=ghg.soil.bac.filter , ncomp=3, method="GCV")
summary(dbplsr.n2o)

#pls is similar to dbplsr but it was easy to get the scores and loadings although I am not totally sure on how to interpret 
require("pls")
dbplsr.n2o <- plsr(ghg.soil.bac.filter$ch4cmgm2hr ~ as.matrix(otu.2.rel.dist), data=ghg.soil.bac.filter , ncomp=6)
summary(dbplsr.n2o)
scores(dbplsr.n2o)
loadings(dbplsr.n2o)
###Some loadings are missing ... ?
loadingplot(dbplsr.n2o, comps = 1:6, legendpos = "topright")
biplot(dbplsr.n2o)

# + scale(as.matrix(soil.dist))

```

```{r mantel soil and bac comm }

soil.dist <- vegdist(x = scale(ghg.soil.bac.filter[, -c(1:8)]), "euclid")

bac.soil.mantel <- mantel(as.matrix(soil.dist), as.matrix(otu.2.rel.dist), method="pearson", permutations=999)
bac.soil.mantel

```

```{r Bacteria Indicator Species}
#This produces a text file with otus for groups and p values
#i <- interaction(new.data$treatment, new.data$month)
new.data <-cbind(meta,otu.2.rel)
library("labdsv")
###treatment and month? 

design.type <- new.data$treatment
dataREL.2013 <- new.data[,-c(1:5)]
#head(dataREL.2013)
set.seed(42)
#dataREL <- dataREL.2013
###This sets abundance cutoff
###Sensitive to abudnace cutoff
head(dataREL.2013)
dataREL <- dataREL.2013[, colSums(dataREL.2013) > 0.05]
bac.ind <- indval(dataREL, clustering =  design.type, numitr=1000, set.seed(42))
levels(design.type)
design.type
summary(bac.ind)

###this sets p value cutoff
inds <- which(bac.ind$pval <= 0.05)
bac.indicators <- as.data.frame(matrix(NA, nrow = length(inds), ncol = 4))
colnames(bac.indicators) <- c("OTU", "Cluster", "IndVal", "Prob")

bac.indicators$OTU <- names(inds)
bac.indicators$Cluster <- bac.ind$maxcls[inds]
bac.indicators$IndVal <- bac.ind$indcls[inds]
bac.indicators$Prob <- bac.ind$pval[inds]

#need tax data

otu.tax<-as.data.frame(tax)
suffix<- 1:nrow(otu.tax)
ps <- sprintf("Otu%05d",suffix)
otu.tax$OTU<-ps

ind.tax <- otu.tax[which(as.character(otu.tax$OTU) %in% bac.indicators$OTU), ]
ind.tax <- ind.tax[match(ind.tax$OTU, bac.indicators$OTU), ]

indicator.bac <- cbind(bac.indicators, ind.tax[, -c(1)])
indicator.bac <- indicator.bac[order(as.numeric(indicator.bac$Cluster)), ]

table(indicator.bac$Cluster)
table(indicator.bac$Phylum)
table(indicator.bac$Cluster)
levels(design.type)

# Export Bacteria Indicator Table
write.table(indicator.bac, "../figures/BacterialIndicators_treatment_all.txt",
            sep="\t", row.names = F, quote = F)

```


```{r heatmap of relative abundances}
ra.heat <- metaotu %>%
  gather(otu, "otu.cnt", -treatment, -season) %>%
  mutate(otu.cnt = as.numeric(otu.cnt))%>%
  filter(otu.cnt >= 0.0055)

#ra.heat <- ra.heat[-c(1:44),]

ra.heat.sum <- ra.heat %>%
    group_by(treatment, season, otu) %>%
    dplyr::summarise(avgAbund=mean(otu.cnt)*100)%>%
    left_join(tax.df, by="otu") %>%
    filter(Phylum != "Bacteria_unclassified")

#By plot?
ind.tax.i.heat <- ggplot(ra.heat.sum, aes(Genus, treatment)) +
  geom_tile(aes(fill = avgAbund), color="white") + 
  scale_fill_gradientn(colors=c("khaki", "green", "blue", "black"))+#, limits=c(0.001,0.005), oob=scales::squish) +
  scale_y_discrete(labels=c("flooded", "shallow land"))+
  labs(fill = "", title="", x="", y="" )+
  guides(fill=guide_legend(title=(expression(paste("% Relative \n Abundance"))))) +
  theme_bw()  +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          axis.title.y=element_text(margin=margin(r=10)), 
          axis.title.x=element_text(margin=margin(t=10))) +
    theme(axis.title=element_text(vjust=1,size=16),
          axis.text=element_text(size=14), axis.text.x = element_text(size=14))+
    theme(legend.text=element_text(size=14), legend.title = element_text(size=14), 
          legend.position = "right")+
  coord_flip()
ind.tax.i.heat

ggsave("../figures/heatmap.jpg", plot=ind.tax.i.heat, device=NULL, path=NULL, scale=1, width=9, height=9, dpi=900, limitsize=TRUE)
```


###Have not revisited these sections below
```{r water quality, echo=T, out.width="100%"}
#water data
water <-read.csv("../data/CSW_Water_Nutes.csv")
water<-water %>% filter(plot!="5-South Inlet", Station != "CSW_007", Station!="CSW_012") %>%
mutate(NO3.NO2.1 = ifelse(NO3.NO2.1 < 0 , 0, NO3.NO2.1))
```

```{r water NH4.1 = NH4 mg/l}
water.lm <- lm(NH4.1~plot+season,data=water)
plot(water.lm)
anova(water.lm)
summary(water.lm)

posthoc <- HSD.test(water.lm, "plot", group=T)
posthoc$groups

anova2<-(aov(NH4.1~as.factor(plot)+as.factor(season),data=water))
posthoc <- TukeyHSD(anova2, group=T)
posthoc

p1 <- ggplot(water, aes(x=plot, y=NH4.1, color=as.factor(season), shape=as.factor(season))) + stat_summary(fun.data=mean_cl_boot,size=1.25, position=position_dodge(width=0.5)) + scale_color_manual(name="Season", values=c("darkgreen","red", "orange", "navy"), labels = c("spring", "summer","fall","winter")) + scale_shape_manual(name="Season", values=c(15,16,17,18), labels = c("spring", "summer","fall","winter"))

p1 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=20,face="bold"), axis.text=element_text(size=20), axis.text.x = element_text(vjust=0.65, hjust=0.5, angle=45, size=16), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Sample Location", y = (expression(paste("NH"[4], " mg L"^-{1})))) + theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=20, face="bold"), strip.background = element_rect(colour="black", fill="white", size=3))

ggsave("../figures/nh4.jpeg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)
```

```{r water:NO3+NO2. = NO3 + NO2 mg/L}
water.lm <- lm(NO3.NO2.1~plot+ season,data=water)
plot(water.lm)
anova(water.lm)
summary(water.lm)

posthoc <- HSD.test(water.lm, "season", group=T)
posthoc$groups

anova2<-(aov(NH4.1~as.factor(plot)+as.factor(season),data=water))
#car::Anova(anova2, type="III")
posthoc <- TukeyHSD(anova2, group=T)
posthoc

p2 <- ggplot(water, aes(x=plot, y=NO3.NO2.1, color=as.factor(season), shape=as.factor(season))) + stat_summary(fun.data=mean_cl_boot,size=1.25, position=position_dodge(width=0.5)) + scale_color_manual(name="Season", values=c("darkgreen","red", "orange", "navy"), labels = c("spring", "summer","fall","winter")) + scale_shape_manual(name="Season", values=c(15,16,17,18), labels = c("spring", "summer","fall","winter"))

p2 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=20,face="bold"), axis.text=element_text(size=20), axis.text.x = element_text(vjust=0.65, hjust=0.5, angle=45, size=16), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Sample Location", y = (expression(paste("NO"[3],"+NO"[2], " mg L"^-{1})))) + theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=20, face="bold"), strip.background = element_rect(colour="black", fill="white", size=3))

ggsave("../figures/no3.jpeg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)
```

```{r water: PO4.1 = phosphate mg/L}
water.lm <- lm(PO4.1~plot+season,data=water)
plot(water.lm)
anova(water.lm)
summary(water.lm)

posthoc <- HSD.test(water.lm, "season", group=T)
posthoc$groups

anova2<-(aov(PO4.1~as.factor(plot)+as.factor(season),data=water))
posthoc <- TukeyHSD(anova2, group=T)
posthoc

p6 <- ggplot(water, aes(x=plot, y=PO4.1, color=as.factor(season), shape=as.factor(season))) + stat_summary(fun.data=mean_cl_boot,size=1.25, position=position_dodge(width=0.5)) + scale_color_manual(name="Season", values=c("darkgreen","red", "orange", "navy"), labels = c("spring", "summer","fall","winter")) + scale_shape_manual(name="Season", values=c(15,16,17,18), labels = c("spring", "summer","fall","winter"))

p6 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=20,face="bold"), axis.text=element_text(size=20), axis.text.x = element_text(vjust=0.65, hjust=0.5, angle=45, size=16), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Sample Location", y = (expression(paste("PO"[4], " mg L"^-{1})))) + theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=20, face="bold"), strip.background = element_rect(colour="black", fill="white", size=3))

ggsave("../figures/po4.jpeg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)
```

```{r water: CL.1 = Chloride mg/L}
water.lm <- lm(CL.1~plot+season,data=water)
plot(water.lm)
anova(water.lm)
summary(water.lm)

p8 <- ggplot(water, aes(x=plot, y=CL.1, color=as.factor(season), shape=as.factor(season))) + stat_summary(fun.data=mean_cl_boot,size=1.25, position=position_dodge(width=0.5)) + scale_color_manual(name="Season", values=c("darkgreen","red", "orange", "navy"), labels = c("spring", "summer","fall","winter")) + scale_shape_manual(name="Season", values=c(15,16,17,18), labels = c("spring", "summer","fall","winter"))

p8 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=20,face="bold"), axis.text=element_text(size=20), axis.text.x = element_text(vjust=0.65, hjust=0.5, angle=45, size=16), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Sample Location", y = (expression(paste("Cl mg L"^-{1})))) + theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=20, face="bold"), strip.background = element_rect(colour="black", fill="white", size=3))

ggsave("../figures/cl.jpeg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)

library(grid)
grid.newpage()
grid.draw(rbind(ggplotGrob(p1), ggplotGrob(p2), ggplotGrob(p6), ggplotGrob(p8),  size = "last"))
```

```{r water: DKN, PN, PP, TDP}

water.lm <- lm(DKN.1~season,data=water)
plot(water.lm)
anova(water.lm)

water.lm <- lm(PN.1~season,data=water)
plot(water.lm)
anova(water.lm)

water.lm <- lm(PP.1~season,data=water)
plot(water.lm)
anova(water.lm)

water.lm <- lm(TDP.1~season,data=water)
plot(water.lm)
anova(water.lm)

#Only have for a couple of months... don't think they were run but should verify
#p3 <- ggplot(water, aes(x=plot, y=DKN.1, color=as.factor(season), shape=as.factor(season))) + stat_summary(fun.data=mean_cl_boot,size=1.25, position=position_dodge(width=0.5)) + scale_color_manual(name="Season", values=c("darkgreen","red", "orange", "navy"), labels = c("spring", "summer","fall","winter")) + scale_shape_manual(name="Season", values=c(15,16,17,18), labels = c("spring", "summer","fall","winter"))

#p3 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=20,face="bold"), axis.text=element_text(size=20), axis.text.x = element_text(vjust=0.65, hjust=0.5, angle=45, size=16), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Sample Location", y = (expression(paste("Dissolved N"[4], " mg L"^-{1})))) + theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=20, face="bold"), strip.background = element_rect(colour="black", fill="white", size=3))

#ggsave("../figures/DKN.jpeg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)

p4 <- ggplot(water, aes(x=plot, y=PN.1, color=as.factor(season), shape=as.factor(season))) + stat_summary(fun.data=mean_cl_boot,size=1.25, position=position_dodge(width=0.5)) + scale_color_manual(name="Season", values=c("darkgreen","red", "orange", "navy"), labels = c("spring", "summer","fall","winter")) + scale_shape_manual(name="Season", values=c(15,16,17,18), labels = c("spring", "summer","fall","winter"))

p4 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=20,face="bold"), axis.text=element_text(size=20), axis.text.x = element_text(vjust=0.65, hjust=0.5, angle=45, size=16), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Sample Location", y = (expression(paste("PN mg L"^-{1})))) + theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=20, face="bold"), strip.background = element_rect(colour="black", fill="white", size=3))

ggsave("../figures/pn.jpeg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)


p5 <- ggplot(water, aes(x=plot, y=PP.1, color=as.factor(season), shape=as.factor(season))) + stat_summary(fun.data=mean_cl_boot,size=1.25, position=position_dodge(width=0.5)) + scale_color_manual(name="Season", values=c("darkgreen","red", "orange", "navy"), labels = c("spring", "summer","fall","winter")) + scale_shape_manual(name="Season", values=c(15,16,17,18), labels = c("spring", "summer","fall","winter"))

p5 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=20,face="bold"), axis.text=element_text(size=20), axis.text.x = element_text(vjust=0.65, hjust=0.5, angle=45, size=16), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Sample Location", y = (expression(paste("PP mg L"^-{1})))) + theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=20, face="bold"), strip.background = element_rect(colour="black", fill="white", size=3))

ggsave("../figures/pp.jpeg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)


p7 <- ggplot(water, aes(x=plot, y=TDP.1, color=as.factor(season), shape=as.factor(season))) + stat_summary(fun.data=mean_cl_boot,size=1.25, position=position_dodge(width=0.5)) + scale_color_manual(name="Season", values=c("darkgreen","red", "orange", "navy"), labels = c("spring", "summer","fall","winter")) + scale_shape_manual(name="Season", values=c(15,16,17,18), labels = c("spring", "summer","fall","winter"))

p7 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=20,face="bold"), axis.text=element_text(size=20), axis.text.x = element_text(vjust=0.65, hjust=0.5, angle=45, size=16), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Sample Location", y = (expression(paste("TDP mg L"^-{1})))) + theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=20, face="bold"), strip.background = element_rect(colour="black", fill="white", size=3))

ggsave("../figures/tdp.jpeg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)
```

```{r soil temp}
s <- ggplot(ghg, aes(x = season , y =temp)) + 
  geom_boxplot(aes(color=season), lwd=1)
s + scale_color_manual(name="Season", values=c("darkgreen","red", "orange", "blue"), labels = c("spring", "summer","fall","winter"))  + scale_x_discrete(labels=c("sp" = "spring", "sm" = "summer", "f" = "fall", "w" = "winter"), limits=c("sp", "sm", "f", "w")) + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=20,face="bold"), axis.text=element_text(size=20), axis.text.x = element_text(vjust=0.65, hjust=0.5, angle=45, size=16), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Season", y = (expression(paste('Soil Temperature (',~degree,'C)',sep='')))) + theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=20, face="bold"), strip.background = element_rect(colour="black", fill="white", size=1))

ggsave("../figures/SoilTemp.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)
```

```{r moist.percent = soil moisture}
soil.lm <- lm(moist.percent~hydrology+season,data=design)
plot(soil.lm)
anova(soil.lm)
summary(soil.lm)

posthoc <- HSD.test(soil.lm, "hydrology", group=T)
posthoc$groups

anova2<-(aov(moist.percent~as.factor(hydrology),data=design))
posthoc <- TukeyHSD(anova2, group=T)
posthoc

p1 <- ggplot(design, aes(x=hydrology, y=moist.percent, color=as.factor(season), shape=as.factor(season))) + stat_summary(fun.data=mean_cl_boot,size=1.25, position=position_dodge(width=0.5)) + scale_color_manual(name="Season", values=c("darkgreen","red", "orange", "navy"), labels = c("spring", "summer","fall","winter")) + scale_shape_manual(name="Season", values=c(15,16,17,18), labels = c("spring", "summer","fall","winter"))

p1 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=20,face="bold"), axis.text=element_text(size=20), axis.text.x = element_text(vjust=0.65, hjust=0.5, angle=45, size=16), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Hydrology", y = (expression(paste("Soil Moisture (%)")))) + theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=20, face="bold"), strip.background = element_rect(colour="black", fill="white", size=3))

ggsave("../figures/SoilMoisture.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)

ggsave("../figures/SoilMoisture.jpeg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)
```

```{r soil pH}
soil.lm <- lm(ph~hydrology,data=design)
plot(soil.lm)
anova(soil.lm)
summary(soil.lm)

posthoc <- HSD.test(soil.lm, "hydrology", group=T)
posthoc$groups

anova2<-(aov(ph~as.factor(hydrology),data=design))
posthoc <- TukeyHSD(anova2, group=T)
posthoc

p1 <- ggplot(design, aes(x=hydrology, y=ph, color=as.factor(season), shape=as.factor(season))) + stat_summary(fun.data=mean_cl_boot,size=1.25, position=position_dodge(width=0.5)) + scale_color_manual(name="Season", values=c("darkgreen","red", "orange", "navy"), labels = c("spring", "summer","fall","winter")) + scale_shape_manual(name="Season", values=c(15,16,17,18), labels = c("spring", "summer","fall","winter"))

p1 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=20,face="bold"), axis.text=element_text(size=20), axis.text.x = element_text(vjust=0.65, hjust=0.5, angle=45, size=16), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Hydrology", y = (expression(paste("pH")))) + theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=20, face="bold"), strip.background = element_rect(colour="black", fill="white", size=3))

ggsave("../figures/pH.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)
```

```{r soil om.percent}
soil.lm <- lm(om.percent~hydrology+season,data=design)
plot(soil.lm)
anova(soil.lm)
summary(soil.lm)

posthoc <- HSD.test(soil.lm, "hydrology", group=T)
posthoc$groups

anova2<-(aov(om.percent~as.factor(hydrology),data=design))
posthoc <- TukeyHSD(anova2, group=T)
posthoc

p1 <- ggplot(design, aes(x=hydrology, y=om.percent, color=as.factor(season), shape=as.factor(season))) + stat_summary(fun.data=mean_cl_boot,size=1.25, position=position_dodge(width=0.5)) + scale_color_manual(name="Season", values=c("darkgreen","red", "orange", "navy"), labels = c("spring", "summer","fall","winter")) + scale_shape_manual(name="Season", values=c(15,16,17,18), labels = c("spring", "summer","fall","winter"))

p1 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=20,face="bold"), axis.text=element_text(size=20), axis.text.x = element_text(vjust=0.65, hjust=0.5, angle=45, size=16), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Hydrology", y = (expression(paste("Soil Organic Matter (%)")))) + theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=20, face="bold"), strip.background = element_rect(colour="black", fill="white", size=3))

ggsave("../figures/SOM.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)
```

```{r soil cn}
soil.lm <- lm(c.n~hydrology+season,data=design)
plot(soil.lm)
anova(soil.lm)
summary(soil.lm)

posthoc <- HSD.test(soil.lm, "hydrology", group=T)
posthoc$groups

anova2<-(aov(c.n~as.factor(hydrology),data=design))
posthoc <- TukeyHSD(anova2, group=T)
posthoc

p1 <- ggplot(design, aes(x=hydrology, y=c.n, color=as.factor(season), shape=as.factor(season))) + stat_summary(fun.data=mean_cl_boot,size=1.25, position=position_dodge(width=0.5)) + scale_color_manual(name="Season", values=c("darkgreen","red", "orange", "navy"), labels = c("spring", "summer","fall","winter")) + scale_shape_manual(name="Season", values=c(15,16,17,18), labels = c("spring", "summer","fall","winter"))

p1 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=20,face="bold"), axis.text=element_text(size=20), axis.text.x = element_text(vjust=0.65, hjust=0.5, angle=45, size=16), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Hydrology", y = (expression(paste("Soil C/N ratio (wt/wt)")))) + theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=20, face="bold"), strip.background = element_rect(colour="black", fill="white", size=3))

ggsave("../figures/SoilCN.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)
```

```{r soil NH4}

soil.lm <- lm(nh4.mgn.l.1~hydrology+season,data=design)
plot(soil.lm)
anova(soil.lm)
summary(soil.lm)

posthoc <- HSD.test(soil.lm, "hydrology", group=T)
posthoc$groups

anova2<-(aov(nh4.mgn.l.1~as.factor(hydrology),data=design))
posthoc <- TukeyHSD(anova2, group=T)
posthoc

p1 <- ggplot(design, aes(x=hydrology, y=nh4.mgn.l.1, color=as.factor(season), shape=as.factor(season))) + stat_summary(fun.data=mean_cl_boot,size=1.25, position=position_dodge(width=0.5)) + scale_color_manual(name="Season", values=c("darkgreen","red", "orange", "navy"), labels = c("spring", "summer","fall","winter")) + scale_shape_manual(name="Season", values=c(15,16,17,18), labels = c("spring", "summer","fall","winter"))

p1 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=20,face="bold"), axis.text=element_text(size=20), axis.text.x = element_text(vjust=0.65, hjust=0.5, angle=45, size=16), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Hydrology", y = (expression(paste("NH"[4], " mg L"^-{1})))) + theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=20, face="bold"), strip.background = element_rect(colour="black", fill="white", size=3))

ggsave("../figures/SoilNH4.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)

ggsave("../figures/SoilNH4.jpeg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)
```

```{r soil NO3}
soil.lm <- lm(no3.mgn.l.1~hydrology+season,data=design)
plot(soil.lm)
anova(soil.lm)
summary(soil.lm)

posthoc <- HSD.test(soil.lm, "hydrology", group=T)
posthoc$groups

anova2<-(aov(no3.mgn.l.1~as.factor(hydrology)+as.factor(season),data=design))
posthoc <- TukeyHSD(anova2, group=T)
posthoc

p1 <- ggplot(design, aes(x=hydrology, y=no3.mgn.l.1, color=as.factor(season), shape=as.factor(season))) + stat_summary(fun.data=mean_cl_boot,size=1.25, position=position_dodge(width=0.5)) + scale_color_manual(name="Season", values=c("darkgreen","red", "orange", "navy"), labels = c("spring", "summer","fall","winter")) + scale_shape_manual(name="Season", values=c(15,16,17,18), labels = c("spring", "summer","fall","winter"))

p1 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=20,face="bold"), axis.text=element_text(size=20), axis.text.x = element_text(vjust=0.65, hjust=0.5, angle=45, size=16), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Hydrology", y = (expression(paste("NO"[3],, " mg L"^-{1})))) + theme(strip.text.x = element_text(size=20, face="bold"), strip.text.y = element_text(size=20, face="bold"), strip.background = element_rect(colour="black", fill="white", size=3))

ggsave("../figures/SoilNO3.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)

ggsave("../figures/SoilNO3.jpeg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=6, height=4, dpi=300, limitsize=TRUE)
```



